# MLX90640热成像仪项目技术文档

## 1. 项目概述

本项目实现了一个基于MLX90640热成像传感器的热成像仪，通过STM32F407微控制器读取热成像数据，在LCD触摸屏上显示热成像图像，并通过两个舵机实现自动瞄准温度最高位置的功能。项目使用LVGL图形库实现了友好的用户界面，支持温度数据分析、图表显示、温度分布可视化等功能。

### 1.1 核心功能

- 实时热成像图像显示
- 温度最高/最低点自动检测和标记
- 舵机自动瞄准温度最高点
- 温度分布直方图显示
- 温度统计信息（最高/最低温度、平均温度、方差等）
- 快照/实时流模式切换
- 信息面板显示/隐藏
- 触摸屏交互操作

### 1.2 硬件组成

- **主控制器**：STM32F407微控制器
- **传感器**：MLX90640热成像传感器（32×24像素分辨率）
- **显示设备**：LCD触摸屏（320×240像素分辨率）
- **执行器**：两个舵机（水平和垂直方向）
- **通信接口**：
  - I2C：连接MLX90640传感器（SCL: PG2, SDA: PG4）
  - PWM：控制舵机（舵机0(水平): PA8, 舵机1(垂直): PB8）
  - USART：调试通信（UART3: TX-PC10/RX-PC11, UART5: TX-PC12/RX-PD2）
  - SPI：LCD屏幕通信

## 2. 系统架构

### 2.1 软件架构

项目软件架构采用分层设计，主要包括：

1. **硬件抽象层**：位于BaseDrive目录下，包含所有硬件驱动程序
   - servo：舵机驱动
   - mlx90640：MLX90640传感器驱动
   - TOUCH：触摸屏驱动
   - USART：串口通信驱动
   - MLX90640_I2C_Driver：MLX90640 I2C通信驱动

2. **应用层**：位于User目录下，包含主程序和算法实现
   - main.c：程序入口和主循环
   - linear_interpolation.c/.h：线性插值算法（分辨率转换）

3. **UI框架层**：使用LVGL图形库，位于lvgl目录下
   - 负责图形界面的绘制和交互
   - 提供图表、按钮、标签等UI组件

### 2.2 程序流程

1. **系统初始化**
   - 系统时钟配置
   - GPIO初始化
   - 串口USART3/UART5配置
   - 舵机初始化
   - LCD和触摸屏初始化
   - LVGL图形库初始化
   - 定时器配置

2. **UI创建**
   - 创建热成像显示区域
   - 创建温度信息标签
   - 创建按钮和控制组件
   - 创建图表区域
   - 创建日志区域

3. **主循环**
   - 接收MLX90640传感器数据（通过串口5）
   - 处理热成像数据（温度计算、统计分析）
   - 更新UI显示（热成像图、温度信息、图表）
   - 控制舵机指向最高温度点
   - 处理触摸事件
   - 执行LVGL定时器任务
   - 实现双缓冲区切换机制

## 3. 关键模块详解

### 3.1 MLX90640热成像传感器

MLX90640是一个32×24像素的远红外热成像传感器，通过I2C接口与STM32F407通信。在本项目中，实际上传感器数据是通过串口5接收的，这可能是因为使用了外部处理模块来处理原始传感器数据。

#### 数据格式

传感器数据通过串口接收，格式为：
- 前4字节为数据头
- 之后是32×24=768个温度点的数据，每个点占用2字节
- 数据以小端格式存储，需要进行转换：`temp = ((int16_t)data_buf[i*2+1+4] << 8 | data_buf[i*2+4])`
- 温度值需要乘以0.01来获得实际摄氏度值

#### 数据处理流程

1. 通过串口接收传感器数据
2. 对数据进行校验（Check函数）
3. 遍历768个温度点，计算：
   - 最高/最低温度及其坐标
   - 平均温度和温度方差
   - 温度分布直方图数据
4. 将温度数据映射为颜色，生成热成像图

### 3.2 舵机控制系统

项目使用两个舵机实现自动瞄准功能，通过PWM信号控制舵机角度。

#### 舵机配置

- **舵机0（水平方向）**：
  - 引脚：PA8
  - 控制器：TIM1 CH1
  - 角度范围：0-90度

- **舵机1（垂直方向）**：
  - 引脚：PB8
  - 控制器：TIM10 CH1
  - 角度范围：0-45度

#### PWM参数

- 周期：20ms（频率50Hz）
- 占空比计算：`pulse = 1500 + 11 * angle`
- 水平舵机（舵机0）：角度从0到90度映射
- 垂直舵机（舵机1）：角度从0到45度映射，注意垂直舵机使用反向映射`pulse += 11 * (45-angle)`

#### 瞄准算法

- 获取温度最高点的坐标(max_temp_x, max_temp_y)
- 水平舵机角度 = 90 * (max_temp_x / 32)
- 垂直舵机角度 = 45 * (max_temp_y / 24)

### 3.3 图像处理与显示

#### 分辨率转换

MLX90640传感器的分辨率为32×24像素，而LCD屏幕分辨率为320×240像素，需要进行分辨率转换。

虽然项目中有线性插值算法的文件，但从代码中可以看出，实际使用的是更简单的方法来处理图像显示：

1. 创建一个32×24像素的动态图像对象
2. 将温度数据转换为颜色（使用map_temperature_to_color函数）
3. 使用LVGL的缩放功能将图像放大到合适大小（使用`lv_img_set_zoom`函数）

#### 颜色映射

颜色映射使用了从蓝色到黄色再到红色的渐变：
- 低温：蓝色 (0, 0, 255)
- 中温：黄色 (255, 255, 0)
- 高温：红色 (255, 0, 0)

映射算法实现在`map_temperature_to_color`函数中：
```c
lv_color_t map_temperature_to_color(float temperature, float min_t, float max_t){
	if (temperature < min_t) {
		temperature = min_t;
	}
	if (temperature > max_t) {
		temperature = max_t;
	}
	// 蓝色 -> 黄色 -> 红色
	// 0 0 255 -> 255 255 0 -> 255 0 0
	float ratio = (temperature - min_t) / (max_t - min_t);
	uint8_t r = 0, g = 0, b = 0;
	if(ratio < 0.5){
		r = 255 * ratio * 2;
		g = 255;
		b = 255 - 255 * ratio * 2;
	}else{
		r = 255;
		g = 255 - 255 * (ratio - 0.5) * 2;
		b = 0;
	}
	return lv_color_make(r, g, b);
}
```

#### 双缓冲机制

为了优化显示性能，项目使用了双缓冲机制：
- 两个缓冲区（buffer_a和buffer_b）交替使用
- 一个缓冲区用于显示，另一个用于数据更新
- 使用标志位（updating_buffer_flag）控制当前正在更新的缓冲区
- 使用disp_finish_flag标志位防止数据冲突

### 3.4 用户界面

用户界面基于LVGL图形库实现，主要包括以下组件：

#### 热成像显示区

- 位于屏幕左侧，显示热成像图像
- 使用颜色映射表示不同温度
- 自动跟踪和标记最高温度点

#### 温度信息区

显示温度相关信息，包括：
- 最高/最低温度值
- 最高/最低温度点坐标
- 舵机角度信息
- 平均温度和方差
- 时间戳

#### 图表区域

- 显示温度分布直方图
- 横轴表示图像的水平方向（32个点）
- 纵轴表示温度值（映射到0-90范围）

#### 控制按钮

- **snapshot/streaming按钮**：切换快照和实时流模式
- **info按钮**：显示/隐藏信息面板

#### 动画效果

- 使用动画标记最高温度点
- 十字线指示器跟随最高温度点移动
- 使用LVGL动画API实现平滑过渡效果

## 4. 技术挑战与解决方案

### 4.1 分辨率转换问题

**挑战**：MLX90640传感器的分辨率是32×24像素，而屏幕的分辨率是320×240像素，需要进行分辨率转换。

**解决方案**：
- 最初计划使用线性插值算法进行分辨率转换
- 实际实现中，利用LVGL的图像缩放功能简化了这一过程
- 创建小尺寸图像并使用`lv_img_set_zoom`放大显示

### 4.2 内存限制问题

**挑战**：320×240的数据需要约150KB的内存，而STM32F407的SRAM只有192KB。

**解决方案**：
- 采用原始32×24尺寸的图像，减少内存占用
- 使用双缓冲机制，每次只处理和显示必要的数据
- 优化数据结构，减少冗余信息

### 4.3 刷新率优化

**挑战**：完整的数据处理会导致刷新率过低。

**解决方案**：
- 使用双缓冲技术，一个缓冲区用于显示，另一个用于数据处理
- 使用标志位（disp_finish_flag）防止数据冲突
- 定时器中断处理LVGL任务，保证UI响应性
- 5ms调用一次LVGL任务处理器，平衡性能和响应性

### 4.4 温度数据统计分析

**挑战**：需要实时计算大量温度数据的统计信息，如平均温度和方差。

**解决方案**：
- 使用增量法计算均值和方差，避免多次遍历数据
- 代码实现：
```c
// 增量法计算均值和方差
delta = Temperature - mean_temp;
mean_temp += delta / (i + 1);
variance_temp += delta * (Temperature - mean_temp);
```

## 5. 系统参数与配置

### 5.1 硬件接口定义

#### MLX90640热成像传感器
- I2C SCL: PG2
- I2C SDA: PG4

#### 舵机
- 舵机0（水平）: PA8 (TIM1 CH1)
- 舵机1（垂直）: PB8 (TIM10 CH1)

#### 串口
- UART3 TX: PC10
- UART3 RX: PC11
- UART5 TX: PC12
- UART5 RX: PD2

### 5.2 系统参数

- **传感器分辨率**：32×24像素
- **显示分辨率**：320×240像素
- **舵机0角度范围**：0-90度
- **舵机1角度范围**：0-45度
- **I2C通信速率**：400KHz
- **串口波特率**：115200
- **PWM频率**：50Hz（周期20ms）
- **LVGL刷新率**：5ms调用一次

## 二、实验过程

### 2.1 系统开发流程

实验开发过程遵循以下流程：

1. **需求分析与方案设计**
   - 确定系统功能需求
   - 选择合适的硬件组件
   - 设计系统架构和通信方式

2. **硬件平台搭建**
   - 连接MLX90640传感器与STM32F407
   - 连接LCD触摸屏
   - 安装舵机并连接控制信号
   - 配置电源系统

3. **驱动程序开发**
   - MLX90640传感器驱动开发
   - LCD显示驱动开发
   - 舵机控制驱动开发
   - USART通信驱动开发

4. **应用程序开发**
   - LVGL图形界面开发
   - 温度数据处理算法实现
   - 舵机自动瞄准算法实现
   - 系统集成与优化

5. **系统测试与优化**
   - 功能测试
   - 性能优化
   - 界面美化
   - 稳定性测试

```
┌───────────────────┐     ┌───────────────────┐     ┌───────────────────┐
│                   │     │                   │     │                   │
│   需求分析与方案    │────►│   硬件平台搭建    │────►│   驱动程序开发    │
│                   │     │                   │     │                   │
└───────────────────┘     └───────────────────┘     └─────────┬─────────┘
                                                              │
                                                              ▼
┌───────────────────┐     ┌───────────────────┐     ┌───────────────────┐
│                   │     │                   │     │                   │
│  系统测试与优化   │◄────│   应用程序开发    │◄────│   LVGL环境配置     │
│                   │     │                   │     │                   │
└───────────────────┘     └───────────────────┘     └───────────────────┘
```

### 2.2 硬件连接详细流程

#### 2.2.1 MLX90640传感器连接

1. MLX90640传感器通过I2C接口与STM32F407连接
   - SCL连接到PG2引脚
   - SDA连接到PG4引脚
   - 传感器供电为3.3V
   - 增加上拉电阻确保通信稳定

2. 设置I2C通信参数
   - 通信频率：400KHz
   - 7位地址模式
   - 软件复位序列

#### 2.2.2 LCD触摸屏连接

1. LCD触摸屏通过SPI接口与STM32F407连接
   - 配置SPI通信参数
   - 初始化触摸控制器
   - 校准触摸坐标系

2. 显示初始化
   - 配置分辨率为320×240像素
   - 设置颜色格式为RGB565
   - 初始化LVGL显示接口

#### 2.2.3 舵机连接

1. 水平舵机（舵机0）
   - 信号线连接到PA8（TIM1 CH1）
   - 配置PWM参数：20ms周期，占空比1-2ms
   - 角度范围：0-90度

2. 垂直舵机（舵机1）
   - 信号线连接到PB8（TIM10 CH1）
   - 配置相同的PWM参数
   - 角度范围：0-45度

### 2.3 软件开发流程

#### 2.3.1 系统初始化流程

```
┌─────────────────┐
│ 系统启动        │
└────────┬────────┘
         ▼
┌────────────────┐
│ 系统时钟配置   │
└────────┬───────┘
         ▼
┌────────────────┐
│ 外设初始化     │
│ (GPIO,USART等) │
└────────┬───────┘
         ▼
┌────────────────┐
│ LCD/触摸屏初始化│
└────────┬───────┘
         ▼
┌────────────────┐
│ LVGL初始化     │
└────────┬───────┘
         ▼
┌────────────────┐
│ 创建UI组件     │
└────────┬───────┘
         ▼
┌────────────────┐
│ 进入主循环     │
└────────────────┘
```

#### 2.3.2 主循环处理流程

```
┌────────────────────┐
│ 主循环开始         │
└─────────┬──────────┘
          ▼
┌────────────────────┐     ┌─────────────────┐
│ 检查串口数据缓冲区 │─────►│ 数据不可用     │
└─────────┬──────────┘     └─────────────────┘
          │
          │ 数据可用
          ▼
┌────────────────────┐     ┌─────────────────┐
│ 验证数据校验和     │─────►│ 校验失败，丢弃 │
└─────────┬──────────┘     └─────────────────┘
          │
          │ 校验成功
          ▼
┌────────────────────┐
│ 处理温度数据       │
│ - 计算最高/最低温度│
│ - 计算平均值/方差  │
│ - 更新直方图数据   │
└─────────┬──────────┘
          ▼
┌────────────────────┐
│ 更新热成像显示     │
│ - 生成颜色图像     │
│ - 切换双缓冲区     │
└─────────┬──────────┘
          ▼
┌────────────────────┐
│ 更新UI信息         │
│ - 更新温度标签     │
│ - 更新直方图       │
└─────────┬──────────┘
          ▼
┌────────────────────┐
│ 控制舵机瞄准       │
│ - 计算目标角度     │
│ - 设置舵机PWM      │
└─────────┬──────────┘
          ▼
┌────────────────────┐
│ 处理LVGL任务       │
└─────────┬──────────┘
          ▼
┌────────────────────┐
│ 处理触摸输入       │
└─────────┬──────────┘
          ▼
┌────────────────────┐
│ 返回循环开始       │
└────────────────────┘
```

### 2.4 关键算法实现

#### 2.4.1 温度数据处理算法

1. **最高/最低温度检测**
   - 遍历所有温度点，找出最值
   - 记录最值对应的坐标位置

2. **增量计算平均值和方差**
   ```c
   // 增量法计算均值和方差
   delta = Temperature - mean_temp;
   mean_temp += delta / (i + 1);
   variance_temp += delta * (Temperature - mean_temp);
   ```

#### 2.4.2 舵机角度映射算法

根据最高温度点的坐标，计算舵机角度：
```c
// 舵机角度计算
// 水平舵机角度
servo0_angle = 90 * (float)max_temp_x / 32;
// 垂直舵机角度
servo1_angle = 45 * (float)max_temp_y / 24;
```

#### 2.4.3 颜色映射算法

将温度值映射为颜色值：
```c
// 计算温度在范围内的比例
float ratio = (temperature - min_t) / (max_t - min_t);

// 蓝色->黄色->红色渐变
if(ratio < 0.5){
    r = 255 * ratio * 2;
    g = 255;
    b = 255 - 255 * ratio * 2;
}else{
    r = 255;
    g = 255 - 255 * (ratio - 0.5) * 2;
    b = 0;
}
```

#### 2.4.4 双缓冲切换机制

```c
// 交换缓冲区
void swap_buffers(lv_obj_t* img){
    if(updating_buffer_flag == 0){
        dynamic_img_dsc.data = (const uint8_t*)buffer_b;
    }else{
        dynamic_img_dsc.data = (const uint8_t*)buffer_a;
    }
    lv_img_set_src(img, &dynamic_img_dsc);
    lv_obj_invalidate(img);
    updating_buffer_flag = !updating_buffer_flag;
}
```

### 2.5 系统测试与调试

1. **功能测试**
   - 测试热成像显示功能
   - 测试舵机控制精度
   - 测试UI交互响应性

2. **性能优化**
   - 优化数据处理流程
   - 降低LVGL刷新负担
   - 平衡图像质量和刷新率

3. **系统稳定性测试**
   - 长时间运行测试
   - 边界条件测试
   - 异常情况恢复测试

graph TD
    classDef process fill:#E5F6FF,stroke:#73A6FF,stroke-width:2px;
    A(系统启动):::process --> B(系统时钟配置):::process
    B --> C(外设初始化<br>(GPIO,USART等)):::process
    C --> D(LCD/触摸屏初始化):::process
    D --> E(LVGL初始化):::process
    E --> F(创建UI组件):::process
    F --> G(进入主循环):::process